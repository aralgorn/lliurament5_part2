<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teachable Machine Image Model</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

  <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-lg text-center space-y-6">
    <h1 class="text-2xl font-semibold text-indigo-600">Teachable Machine Image Model</h1>

    <button onclick="init()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl hover:bg-indigo-700 transition">
      Start Webcam
    </button>

    <div id="webcam-container" class="flex justify-center"></div>
    <div id="label-container" class="space-y-2 text-left"></div>

    <hr class="my-4"/>

    <!-- Subir imagen desde archivo -->
    <div class="space-y-2">
      <label class="block text-gray-600 font-medium">Sube una imagen:</label>
      <input type="file" accept="image/*" onchange="handleFileUpload(event)" class="w-full border p-2 rounded-md"/>
    </div>

    <!-- Usar URL de imagen -->
    <div class="space-y-2">
      <label class="block text-gray-600 font-medium">O analiza desde URL:</label>
      <input id="image-url" type="text" placeholder="https://..." class="w-full border p-2 rounded-md"/>
      <button onclick="predictFromURL()" class="mt-2 bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600 transition">
        Analizar URL
      </button>
    </div>

    <div id="image-preview" class="mt-4 flex justify-center"></div>
  </div>

  <script type="text/javascript">
    const URL = "./";
    let model, webcam, labelContainer, maxPredictions;

    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      const flip = true;
      webcam = new tmImage.Webcam(200, 200, flip);
      await webcam.setup();
      await webcam.play();
      window.requestAnimationFrame(loop);

      document.getElementById("webcam-container").appendChild(webcam.canvas);
      labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = "";
      for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
      }
    }

    async function loop() {
      webcam.update();
      await predict(webcam.canvas);
      window.requestAnimationFrame(loop);
    }

    async function predict(source) {
      const prediction = await model.predict(source);
      for (let i = 0; i < maxPredictions; i++) {
        const classPrediction = `${prediction[i].className}: ${prediction[i].probability.toFixed(2)}`;
        labelContainer.childNodes[i].innerHTML = classPrediction;
      }
    }

    // Función para subir archivo desde el sistema local
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = async () => {
        document.getElementById("image-preview").innerHTML = "";
        document.getElementById("image-preview").appendChild(img);
        await predict(img);
      };
      img.className = "max-w-xs rounded shadow";
      img.src = URL.createObjectURL(file);
    }

    // Función para cargar y predecir desde una URL
    async function predictFromURL() {
      const url = document.getElementById("image-url").value;
      if (!url) return;

      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = async () => {
        document.getElementById("image-preview").innerHTML = "";
        document.getElementById("image-preview").appendChild(img);
        await predict(img);
      };
      img.className = "max-w-xs rounded shadow";
      img.src = url;
    }
  </script>
</body>
</html>
